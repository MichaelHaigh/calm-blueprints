{"status":{},"contains_secrets":false,"product_version":"2.9.7","spec":{"description":"* [Jenkins](http:\/\/@@{Jenkins_Master.address}@@:8080)\n* [Gitea](https:\/\/@@{Gitea.address}@@:3000)","resources":{"client_attrs":{"f4888580-fc50-4118-945c-7a6dfbaca121":{"y":-68,"x":128},"95c1ab56_deployment":{"y":406.1692217724,"x":-92.9629516232},"4ea1d498-4957-44d0-be28-eaf6c7aad6f4":{"y":-63,"x":-111},"ffdda4d4_deployment":{"y":85,"x":127.5},"817b1233-9f51-4db0-a248-5b042dbf6647":{"y":-68,"x":128},"53b9c619-b146-4e7f-80be-ac11288953a4":{"y":-63,"x":-111},"a354950e-8c37-4380-b219-cde3a9e2f287":{"y":-68,"x":128},"0d703be9_deployment":{"y":416.2110713336,"x":-494.6585080085},"b7e85a06_deployment":{"y":403.5529846253,"x":312.9822974559},"4a5df9a2-4664-f2af-adce-39c475ea4dcb":{"y":381.4177120475,"x":319.3210332889},"c68d81e9-dbca-4ac7-9543-dea7eecd9ebb":{"y":-63,"x":-111},"0fde77f8-9744-4ef7-9a3f-51fe07b3347b":{"y":-68,"x":128},"None":{"y":140,"x":300},"487f0f9a_deployment":{"y":83.6935927425,"x":-291.2590403359},"1a188673-5721-b8c1-f522-3d37e936ff64":{"y":183.25,"x":-36.80078125},"2edaa3ae-71b9-42f9-8e57-573915e7d54c":{"y":-63,"x":-111}},"service_definition_list":[{"singleton":false,"action_list":[{"description":"System action for creating an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Jenkins_Master"},"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"InstallPlugins"},{"kind":"app_task","name":"GetAuthPassword"},{"kind":"app_task","name":"TrustGitCA"}],"name":"6867bf21_dag","attrs":{"edges":[{"from_task_reference":{"kind":"app_task","name":"InstallPlugins"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"GetAuthPassword"}},{"from_task_reference":{"kind":"app_task","name":"GetAuthPassword"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"TrustGitCA"}}],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Jenkins_Master"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"InstallPlugins","attrs":{"script":"#!\/bin\/bash\nset -ex\n\n#Install Basic plugins\nsudo yum -y install unzip\nsudo curl -o batch-install-jenkins-plugins.sh https:\/\/gist.githubusercontent.com\/micw\/e80d739c6099078ce0f3\/raw\/33a21226b9938382c1a6aa68bc71105a774b374b\/install_jenkins_plugin.sh\nsudo chmod +x batch-install-jenkins-plugins.sh\necho 'credentials-binding\nbouncycastle-api\nwindows-slaves\nssh-credentials \nssh-slaves\ncredentials\nplain-credentials\ncredentials-binding\nauthentication-tokens\nnutanix-calm\ndocker-plugin\nkubernetes\nkubernetes-cd\npam-auth\nscript-security\ncloudbees-folder\ncloudbees-credentials\ngitea\nworkflow-aggregator' | sudo tee plugins\n\ngit config --global http.sslVerify false\nsudo systemctl stop jenkins\nsudo mkdir -p \/var\/lib\/jenkins\/plugins\n#sudo .\/batch-install-jenkins-plugins.sh -p plugins -d \/var\/lib\/jenkins\/plugins\nsudo .\/batch-install-jenkins-plugins.sh $(echo $(cat plugins))\nsudo systemctl start jenkins \nsleep 60","type":"","command_line_args":"","exit_status":[],"script_type":"sh"},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Jenkins_Master"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"GetAuthPassword","attrs":{"exit_status":[],"script":"#!\/bin\/bash\n\necho \"authpwd=\"$(sudo cat \/var\/lib\/jenkins\/secrets\/initialAdminPassword)","eval_variables":["authpwd"],"eval_scope":"local","type":"","script_type":"sh"},"timeout_secs":"0","type":"SET_VARIABLE","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Jenkins_Master"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"TrustGitCA","attrs":{"exit_status":[],"script":"#!\/bin\/bash\nset -ex\n\n# Create the CA cert file from the variable, move into proper folder, update permissions and trust\necho -n '@@{Gitea.GITEA_CA}@@' | base64 --decode >> gitca.crt\nsudo mv gitca.crt \/etc\/pki\/ca-trust\/source\/anchors\/.\nsudo chown root:root \/etc\/pki\/ca-trust\/source\/anchors\/gitca.crt\nsudo chmod 644 \/etc\/pki\/ca-trust\/source\/anchors\/gitca.crt\nsudo update-ca-trust","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"CENTOS"}},"timeout_secs":"0","type":"EXEC","variable_list":[]}],"description":"","name":"649ebb9f_runbook","main_task_local_reference":{"kind":"app_task","name":"6867bf21_dag"},"variable_list":[]},"name":"action_create"},{"description":"System action for deleting an application. Deletes created VMs as well","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Jenkins_Master"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"b6f75d2f_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"41524ac0_runbook","main_task_local_reference":{"kind":"app_task","name":"b6f75d2f_dag"},"variable_list":[]},"name":"action_delete"},{"description":"System action for starting an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Jenkins_Master"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"4828f091_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"d23157a1_runbook","main_task_local_reference":{"kind":"app_task","name":"4828f091_dag"},"variable_list":[]},"name":"action_start"},{"description":"System action for stopping an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Jenkins_Master"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"9736c6d3_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"4b4d2d04_runbook","main_task_local_reference":{"kind":"app_task","name":"9736c6d3_dag"},"variable_list":[]},"name":"action_stop"},{"description":"System action for restarting an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Jenkins_Master"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"ff4f877b_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"0a872297_runbook","main_task_local_reference":{"kind":"app_task","name":"ff4f877b_dag"},"variable_list":[]},"name":"action_restart"},{"description":"System action for deleting an application. Does not delete created VMs","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Jenkins_Master"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"efa70809_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"b64cd6dc_runbook","main_task_local_reference":{"kind":"app_task","name":"efa70809_dag"},"variable_list":[]},"name":"action_soft_delete"}],"depends_on_list":[],"name":"Jenkins_Master","port_list":[],"tier":"","variable_list":[{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"authpwd","value":"","label":"","attrs":{"type":""},"is_hidden":false}],"description":""},{"singleton":false,"action_list":[{"description":"System action for creating an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Jenkins_Slave"},"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"InstallJenkinsCLI"},{"kind":"app_task","name":"CreateCredAndNode"}],"name":"e07d737d_dag","attrs":{"edges":[{"from_task_reference":{"kind":"app_task","name":"InstallJenkinsCLI"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"CreateCredAndNode"}}],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Jenkins_Slave"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"InstallJenkinsCLI","attrs":{"script":"#!\/bin\/bash\n\n#Download jenkins-cli\nsudo yum -y install wget\nsudo wget http:\/\/@@{Jenkins_Master.address}@@:8080\/jnlpJars\/jenkins-cli.jar\ngit config --global http.sslVerify false","type":"","command_line_args":"","exit_status":[],"script_type":"sh"},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Jenkins_Slave"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"CreateCredAndNode","attrs":{"script":"#!\/bin\/bash\n\n\nJENKINS_URL=http:\/\/@@{Jenkins_Master.address}@@:8080\nNODE_NAME=@@{address}@@\nNODE_SLAVE_HOME='\/home\/centos'\nEXECUTORS=1\nSSH_PORT=22\nCRED_ID=Jenkins_Slave\nLABELS='build docker'\nUSERID=admin\n\necho \"Creating credential\"\n\n#Create credential\necho '<com.cloudbees.jenkins.plugins.sshcredentials.impl.BasicSSHUserPrivateKey plugin=\"ssh-credentials@1.13\">\n  <scope>GLOBAL<\/scope>\n  <id>Jenkins_Slave<\/id>\n  <description><\/description>\n  <username>@@{CENTOS.username}@@<\/username>\n  <privateKeySource class=\"com.cloudbees.jenkins.plugins.sshcredentials.impl.BasicSSHUserPrivateKey$DirectEntryPrivateKeySource\">\n    <privateKey>\n    @@{CENTOS.secret}@@\n    <\/privateKey>\n  <\/privateKeySource>\n<\/com.cloudbees.jenkins.plugins.sshcredentials.impl.BasicSSHUserPrivateKey>' | sudo java -jar jenkins-cli.jar -s \"${JENKINS_URL}\"  -http -auth ${USERID}:@@{Jenkins_Master.authpwd}@@ create-credentials-by-xml system::system::jenkins _\n\necho \"Creating slave node\"\n\n#Create Slave Node\ncat <<EOF | sudo java -jar jenkins-cli.jar -s \"${JENKINS_URL}\" -http -auth ${USERID}:@@{Jenkins_Master.authpwd}@@ create-node ${NODE_NAME}\n<slave>\n  <name>${NODE_NAME}<\/name>\n  <description><\/description>\n  <remoteFS>${NODE_SLAVE_HOME}<\/remoteFS>\n  <numExecutors>${EXECUTORS}<\/numExecutors>\n  <mode>NORMAL<\/mode>\n  <retentionStrategy class=\"hudson.slaves.RetentionStrategy$Always\"\/>\n  <launcher class=\"hudson.plugins.sshslaves.SSHLauncher\" plugin=\"ssh-slaves@1.21\">\n    <host>${NODE_NAME}<\/host>\n    <port>${SSH_PORT}<\/port>\n    <credentialsId>${CRED_ID}<\/credentialsId>\n    <maxNumRetries>0<\/maxNumRetries>\n    <retryWaitTime>0<\/retryWaitTime>\n    <sshHostKeyVerificationStrategy class=\"hudson.plugins.sshslaves.verifiers.NonVerifyingKeyVerificationStrategy\"\/>\n  <\/launcher>\n  <label>${LABELS}<\/label>\n  <nodeProperties\/>\n<\/slave>\nEOF\n","type":"","command_line_args":"","exit_status":[],"script_type":"sh"},"timeout_secs":"0","type":"EXEC","variable_list":[]}],"description":"","name":"93065e63_runbook","main_task_local_reference":{"kind":"app_task","name":"e07d737d_dag"},"variable_list":[]},"name":"action_create"},{"description":"System action for deleting an application. Deletes created VMs as well","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Jenkins_Slave"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"02ad1c31_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"28250c66_runbook","main_task_local_reference":{"kind":"app_task","name":"02ad1c31_dag"},"variable_list":[]},"name":"action_delete"},{"description":"System action for starting an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Jenkins_Slave"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"ca75bdb3_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"9068219c_runbook","main_task_local_reference":{"kind":"app_task","name":"ca75bdb3_dag"},"variable_list":[]},"name":"action_start"},{"description":"System action for stopping an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Jenkins_Slave"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"7838aed7_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"fa556cf2_runbook","main_task_local_reference":{"kind":"app_task","name":"7838aed7_dag"},"variable_list":[]},"name":"action_stop"},{"description":"System action for restarting an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Jenkins_Slave"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"01b88116_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"d304ebd2_runbook","main_task_local_reference":{"kind":"app_task","name":"01b88116_dag"},"variable_list":[]},"name":"action_restart"},{"description":"System action for deleting an application. Does not delete created VMs","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Jenkins_Slave"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"9c198900_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"8ab0b343_runbook","main_task_local_reference":{"kind":"app_task","name":"9c198900_dag"},"variable_list":[]},"name":"action_soft_delete"}],"depends_on_list":[{"kind":"app_service","name":"Jenkins_Master"}],"name":"Jenkins_Slave","port_list":[],"tier":"","variable_list":[],"description":""},{"singleton":false,"action_list":[{"description":"System action for creating an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Workstation"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"ecc16ca1_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"413c887c_runbook","main_task_local_reference":{"kind":"app_task","name":"ecc16ca1_dag"},"variable_list":[]},"name":"action_create"},{"description":"System action for deleting an application. Deletes created VMs as well","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Workstation"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"db954fa6_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"ee5d8fbc_runbook","main_task_local_reference":{"kind":"app_task","name":"db954fa6_dag"},"variable_list":[]},"name":"action_delete"},{"description":"System action for starting an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Workstation"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"01d60a50_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"62c003ba_runbook","main_task_local_reference":{"kind":"app_task","name":"01d60a50_dag"},"variable_list":[]},"name":"action_start"},{"description":"System action for stopping an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Workstation"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"bca12f73_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"c0e99193_runbook","main_task_local_reference":{"kind":"app_task","name":"bca12f73_dag"},"variable_list":[]},"name":"action_stop"},{"description":"System action for restarting an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Workstation"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"d9adfafa_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"f6f39a3c_runbook","main_task_local_reference":{"kind":"app_task","name":"d9adfafa_dag"},"variable_list":[]},"name":"action_restart"}],"depends_on_list":[],"name":"Workstation","port_list":[],"tier":"","variable_list":[],"description":""},{"singleton":false,"action_list":[{"description":"System action for creating an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Kubernetes"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"a7c9d6cd_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"5080586e_runbook","main_task_local_reference":{"kind":"app_task","name":"a7c9d6cd_dag"},"variable_list":[]},"name":"action_create"},{"description":"System action for deleting an application. Deletes created VMs as well","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Kubernetes"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"a418c613_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"599a2c55_runbook","main_task_local_reference":{"kind":"app_task","name":"a418c613_dag"},"variable_list":[]},"name":"action_delete"},{"description":"System action for starting an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Kubernetes"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"6b7848ae_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"40e4f6b8_runbook","main_task_local_reference":{"kind":"app_task","name":"6b7848ae_dag"},"variable_list":[]},"name":"action_start"},{"description":"System action for stopping an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Kubernetes"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"c75f35ee_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"a01359fc_runbook","main_task_local_reference":{"kind":"app_task","name":"c75f35ee_dag"},"variable_list":[]},"name":"action_stop"},{"description":"System action for restarting an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Kubernetes"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"371d3392_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"7cb9747e_runbook","main_task_local_reference":{"kind":"app_task","name":"371d3392_dag"},"variable_list":[]},"name":"action_restart"}],"depends_on_list":[],"name":"Kubernetes","port_list":[],"tier":"","variable_list":[{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"NEW_COOKIES","value":"","label":"","attrs":{"type":""},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}},{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"NEW_KUBECONFIG","value":"","label":"","attrs":{"type":""},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}}],"description":""},{"singleton":false,"action_list":[{"description":"System action for creating an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Gitea"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"f2a5238d_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"8b3f1bb4_runbook","main_task_local_reference":{"kind":"app_task","name":"f2a5238d_dag"},"variable_list":[]},"name":"action_create"},{"description":"System action for deleting an application. Deletes created VMs as well","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Gitea"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"50dce457_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"3760b26f_runbook","main_task_local_reference":{"kind":"app_task","name":"50dce457_dag"},"variable_list":[]},"name":"action_delete"},{"description":"System action for starting an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Gitea"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"aec5b020_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"999e27b6_runbook","main_task_local_reference":{"kind":"app_task","name":"aec5b020_dag"},"variable_list":[]},"name":"action_start"},{"description":"System action for stopping an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Gitea"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"a71b4422_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"a6756dd4_runbook","main_task_local_reference":{"kind":"app_task","name":"a71b4422_dag"},"variable_list":[]},"name":"action_stop"},{"description":"System action for restarting an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Gitea"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"7f2e3aa7_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"10f24be1_runbook","main_task_local_reference":{"kind":"app_task","name":"7f2e3aa7_dag"},"variable_list":[]},"name":"action_restart"}],"depends_on_list":[],"name":"Gitea","port_list":[],"tier":"","variable_list":[{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"GITEA_CA","value":"","label":"","attrs":{"type":""},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}}],"description":""}],"substrate_definition_list":[{"description":"","action_list":[],"type":"AHV_VM","name":"JenkinsAHVMaster","readiness_probe":{"connection_type":"SSH","retries":"5","connection_protocol":"","connection_port":22,"address":"@@{platform.status.resources.nic_list[0].ip_endpoint_list[0].ip}@@","delay_secs":"0","disable_readiness_probe":false,"login_credential_local_reference":{"kind":"app_credential","name":"CENTOS"}},"editables":{"readiness_probe":{"timeout_secs":true},"create_spec":{"resources":{"nic_list":{},"serial_port_list":{},"boot_config":true,"disk_list":{}}}},"os_type":"Linux","create_spec":{"name":"JenkinsMaster-@@{calm_time}@@","resources":{"nic_list":[{"nic_type":"NORMAL_NIC","ip_endpoint_list":[],"network_function_chain_reference":null,"network_function_nic_type":"INGRESS","mac_address":"","subnet_reference":{"kind":"subnet","type":"","name":"","uuid":"0e26c135-d478-428e-9fb8-22c0acfa5f3a"},"type":""}],"serial_port_list":[],"guest_tools":null,"num_vcpus_per_socket":2,"num_sockets":1,"gpu_list":[],"memory_size_mib":4096,"parent_reference":null,"hardware_clock_timezone":"","guest_customization":{"cloud_init":{"meta_data":"","type":"","user_data":"#cloud-config\nusers:\n  - name: centos\n    ssh-authorized-keys:\n      - @@{CENTOS.public_key}@@\n    sudo: ['ALL=(ALL) NOPASSWD:ALL']"},"type":"","sysprep":null},"power_state":"ON","type":"","account_uuid":"4e4f1d3b-9492-4502-9eed-d994192669a4","boot_config":{"boot_device":{"type":"","disk_address":{"type":"","device_index":0,"adapter_type":"SCSI"}},"type":"","boot_type":"","mac_address":""},"disk_list":[{"data_source_reference":{"kind":"app_package","type":"","name":"AHV_CENTOS_76","uuid":"33d24754-17e6-4f02-9f7b-825e9716544f"},"type":"","disk_size_mib":0,"volume_group_reference":null,"device_properties":{"type":"","disk_address":{"type":"","device_index":0,"adapter_type":"SCSI"},"device_type":"DISK"}}]},"availability_zone_reference":null,"backup_policy":null,"type":"","cluster_reference":null,"categories":""},"variable_list":[]},{"description":"","action_list":[],"type":"AHV_VM","name":"JenkinsAHVSlave","readiness_probe":{"connection_type":"SSH","retries":"5","connection_protocol":"","connection_port":22,"address":"@@{platform.status.resources.nic_list[0].ip_endpoint_list[0].ip}@@","delay_secs":"0","disable_readiness_probe":false,"login_credential_local_reference":{"kind":"app_credential","name":"CENTOS"}},"editables":{"readiness_probe":{"timeout_secs":true},"create_spec":{"resources":{"nic_list":{},"serial_port_list":{},"boot_config":true,"disk_list":{}}}},"os_type":"Linux","create_spec":{"name":"JenkinsSlave-@@{calm_array_index}@@-@@{calm_time}@@","resources":{"nic_list":[{"nic_type":"NORMAL_NIC","ip_endpoint_list":[],"network_function_chain_reference":null,"network_function_nic_type":"INGRESS","mac_address":"","subnet_reference":{"kind":"subnet","type":"","name":"","uuid":"0e26c135-d478-428e-9fb8-22c0acfa5f3a"},"type":""}],"serial_port_list":[],"guest_tools":null,"num_vcpus_per_socket":2,"num_sockets":1,"gpu_list":[],"memory_size_mib":4096,"parent_reference":null,"hardware_clock_timezone":"","guest_customization":{"cloud_init":{"meta_data":"","type":"","user_data":"#cloud-config\nusers:\n  - name: centos\n    ssh-authorized-keys:\n      - @@{CENTOS.public_key}@@\n    sudo: ['ALL=(ALL) NOPASSWD:ALL']"},"type":"","sysprep":null},"power_state":"ON","type":"","account_uuid":"4e4f1d3b-9492-4502-9eed-d994192669a4","boot_config":{"boot_device":{"type":"","disk_address":{"type":"","device_index":0,"adapter_type":"SCSI"}},"type":"","boot_type":"","mac_address":""},"disk_list":[{"data_source_reference":{"kind":"app_package","type":"","name":"AHV_CENTOS_76","uuid":"33d24754-17e6-4f02-9f7b-825e9716544f"},"type":"","disk_size_mib":0,"volume_group_reference":null,"device_properties":{"type":"","disk_address":{"type":"","device_index":0,"adapter_type":"SCSI"},"device_type":"DISK"}}]},"availability_zone_reference":null,"backup_policy":null,"type":"","cluster_reference":null,"categories":""},"variable_list":[]},{"description":"","action_list":[],"type":"AHV_VM","name":"Workstation_AHV","readiness_probe":{"connection_type":"SSH","retries":"5","connection_protocol":"","connection_port":22,"address":"@@{platform.status.resources.nic_list[0].ip_endpoint_list[0].ip}@@","delay_secs":"60","disable_readiness_probe":false,"login_credential_local_reference":{"kind":"app_credential","name":"CENTOS"}},"editables":{"create_spec":{"resources":{"nic_list":{},"serial_port_list":{}}}},"os_type":"Linux","create_spec":{"name":"workstation-@@{calm_array_index}@@-@@{calm_time}@@","resources":{"nic_list":[{"nic_type":"NORMAL_NIC","ip_endpoint_list":[],"network_function_chain_reference":null,"network_function_nic_type":"INGRESS","mac_address":"","subnet_reference":{"kind":"subnet","type":"","name":"","uuid":"0e26c135-d478-428e-9fb8-22c0acfa5f3a"},"type":""}],"serial_port_list":[],"guest_tools":null,"num_vcpus_per_socket":1,"num_sockets":2,"gpu_list":[],"memory_size_mib":4096,"parent_reference":null,"hardware_clock_timezone":"","guest_customization":{"cloud_init":{"meta_data":"","type":"","user_data":"#cloud-config\nusers:\n  - name: centos\n    ssh-authorized-keys:\n      - @@{CENTOS.public_key}@@\n    sudo: ['ALL=(ALL) NOPASSWD:ALL']"},"type":"","sysprep":null},"power_state":"ON","type":"","account_uuid":"4e4f1d3b-9492-4502-9eed-d994192669a4","boot_config":{"boot_device":{"type":"","disk_address":{"type":"","device_index":0,"adapter_type":"SCSI"}},"type":"","boot_type":"","mac_address":""},"disk_list":[{"data_source_reference":{"kind":"app_package","type":"","name":"AHV_CENTOS_76","uuid":"33d24754-17e6-4f02-9f7b-825e9716544f"},"type":"","disk_size_mib":0,"volume_group_reference":null,"device_properties":{"type":"","disk_address":{"type":"","device_index":0,"adapter_type":"SCSI"},"device_type":"DISK"}}]},"availability_zone_reference":null,"backup_policy":null,"type":"","cluster_reference":null,"categories":""},"variable_list":[]},{"description":"","action_list":[{"description":"","type":"fragment","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_substrate","name":"Karbon_Kubernetes"},"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"1GetClusters"},{"kind":"app_task","name":"2GetKubeconfig"}],"name":"0ae81090_dag","attrs":{"edges":[{"from_task_reference":{"kind":"app_task","name":"1GetClusters"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"2GetKubeconfig"}}],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_substrate","name":"Karbon_Kubernetes"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"1GetClusters","attrs":{"exit_status":[],"script":"# Set the jwt, headers and payload\njwt = '@@{calm_jwt}@@'\nheaders = {'Content-Type': 'application\/json', 'Accept': 'application\/json',\n           'Authorization': 'Bearer {}'.format(jwt)}\npayload = {}\n\n# Set the address and make images call to get our cookie\nurl = \"https:\/\/localhost:9440\/api\/nutanix\/v3\/images\/list\"\nresp = urlreq(url, verb='POST', params=json.dumps(payload), headers=headers, verify=False)\n\n# If the images call went through successfully, extract the cookie and make acs\/list\nif resp.ok:\n\n  # Set the new headers and cookies, and print cookies for next task\n  headers = {'Content-Type': 'application\/json', 'Accept': 'application\/json'}\n  cookies = {'NTNX_IGW_SESSION': resp.cookies['NTNX_IGW_SESSION']}\n  print \"COOKIES={0}\".format(resp.cookies['NTNX_IGW_SESSION'])\n  \n  # Set the new url and make the call\n  url = \"https:\/\/localhost:7050\/acs\/k8s\/cluster\/list\"\n  resp = urlreq(url, verb='POST', cookies=cookies,\n                params=json.dumps(payload), headers=headers, verify=False)\n  \n  # If the acs\/list call went through successfully, print the ip and uuid of the cluster\n  if resp.ok:\n    for cluster in json.loads(resp.content):\n      if cluster['cluster_metadata']['name'] == \"@@{karbon_cluster_name}@@\":\n        print \"K8S_UUID={0}\".format(cluster['cluster_metadata']['uuid'])\n        print \"K8S_IP={0}\".format(cluster['cluster_metadata']['k8s_config']['master_config']['external_ip'])\n        exit(0)\n    # If we got to this point, we didn't find a matching cluster name\n    print \"ERRROR: A Karbon Kubernetes cluster name of '@@{karbon_cluster_name}@@' was not found.\"\n    print json.dumps(json.loads(resp.content), indent=4)\n    exit(1)\n    \n  # If the acs\/list call failed\n  else:\n    print \"Cluster create failed\", json.dumps(json.loads(resp.content), indent=4)\n    exit(1)\n\n# If the call failed\nelse:\n  print \"Images call failed\", json.dumps(json.loads(resp.content), indent=4)\n  exit(1)\n\n# If we made it this far, there was an error\nprint \"Unknown Error\"\nexit(1)","eval_variables":["COOKIES","K8S_UUID","K8S_IP"],"eval_scope":"local","type":"","script_type":"static"},"timeout_secs":"0","type":"SET_VARIABLE","variable_list":[]},{"target_any_local_reference":{"kind":"app_substrate","name":"Karbon_Kubernetes"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"2GetKubeconfig","attrs":{"exit_status":[],"script":"# Set the headers, payload, and cookies\nheaders = {'Content-Type': 'application\/json', 'Accept': 'application\/json'}\ncookies = {'NTNX_IGW_SESSION': '@@{COOKIES}@@'}\n\n# Set the address and make kubeconfig call\nurl = \"https:\/\/localhost:7050\/acs\/k8s\/cluster\/@@{K8S_UUID}@@\/kubeconfig\"\nresp = urlreq(url, verb='GET', cookies=cookies, headers=headers, verify=False)\n\n# If the call went through successfully, print out the kubeconfig\nif resp.ok:\n  print \"KUBECONFIG={0}\".format(json.loads(resp.content)['yml_config'])\n  exit(0)\n\n# If the call failed\nelse:\n  print \"Get kubeconfig failed\", json.dumps(json.loads(resp.content), indent=4)\n  exit(1)","eval_variables":["KUBECONFIG"],"eval_scope":"local","type":"","script_type":"static"},"timeout_secs":"0","type":"SET_VARIABLE","variable_list":[]}],"description":"","name":"bd4429a1_runbook","main_task_local_reference":{"kind":"app_task","name":"0ae81090_dag"},"variable_list":[]},"name":"pre_action_create"},{"description":"","type":"fragment","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_substrate","name":"Karbon_Kubernetes"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"d0231779_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"e4f8bc50_runbook","main_task_local_reference":{"kind":"app_task","name":"d0231779_dag"},"variable_list":[]},"name":"post_action_delete"}],"type":"EXISTING_VM","name":"Karbon_Kubernetes","readiness_probe":{"connection_type":"SSH","retries":"5","connection_protocol":"","connection_port":22,"address":"@@{ip_address}@@","delay_secs":"60","disable_readiness_probe":true},"os_type":"Linux","create_spec":{"type":"PROVISION_EXISTING_MACHINE","address":"@@{K8S_IP}@@"},"variable_list":[]},{"description":"","action_list":[],"type":"AHV_VM","name":"Gitea_AHV","readiness_probe":{"connection_type":"SSH","retries":"5","connection_protocol":"","connection_port":22,"address":"@@{platform.status.resources.nic_list[0].ip_endpoint_list[0].ip}@@","delay_secs":"60","disable_readiness_probe":false,"login_credential_local_reference":{"kind":"app_credential","name":"CENTOS"}},"editables":{"create_spec":{"resources":{"nic_list":{},"serial_port_list":{}}}},"os_type":"Linux","create_spec":{"name":"gitea-@@{calm_time}@@","resources":{"nic_list":[{"nic_type":"NORMAL_NIC","ip_endpoint_list":[],"network_function_chain_reference":null,"network_function_nic_type":"INGRESS","mac_address":"","subnet_reference":{"kind":"subnet","type":"","name":"","uuid":"0e26c135-d478-428e-9fb8-22c0acfa5f3a"},"type":""}],"serial_port_list":[],"guest_tools":null,"num_vcpus_per_socket":2,"num_sockets":2,"gpu_list":[],"memory_size_mib":8192,"parent_reference":null,"hardware_clock_timezone":"","guest_customization":{"cloud_init":{"meta_data":"","type":"","user_data":"#cloud-config\nusers:\n  - name: centos\n    ssh-authorized-keys:\n      - @@{CENTOS.public_key}@@\n    sudo: ['ALL=(ALL) NOPASSWD:ALL']"},"type":"","sysprep":null},"power_state":"ON","type":"","account_uuid":"4e4f1d3b-9492-4502-9eed-d994192669a4","boot_config":{"boot_device":{"type":"","disk_address":{"type":"","device_index":0,"adapter_type":"SCSI"}},"type":"","boot_type":"","mac_address":""},"disk_list":[{"data_source_reference":{"kind":"app_package","type":"","name":"AHV_CENTOS_76","uuid":"33d24754-17e6-4f02-9f7b-825e9716544f"},"type":"","disk_size_mib":0,"volume_group_reference":null,"device_properties":{"type":"","disk_address":{"type":"","device_index":0,"adapter_type":"SCSI"},"device_type":"DISK"}},{"data_source_reference":null,"type":"","disk_size_mib":51200,"volume_group_reference":null,"device_properties":{"type":"","disk_address":{"type":"","device_index":1,"adapter_type":"SCSI"},"device_type":"DISK"}},{"data_source_reference":null,"type":"","disk_size_mib":51200,"volume_group_reference":null,"device_properties":{"type":"","disk_address":{"type":"","device_index":2,"adapter_type":"SCSI"},"device_type":"DISK"}},{"data_source_reference":null,"type":"","disk_size_mib":51200,"volume_group_reference":null,"device_properties":{"type":"","disk_address":{"type":"","device_index":3,"adapter_type":"SCSI"},"device_type":"DISK"}},{"data_source_reference":null,"type":"","disk_size_mib":51200,"volume_group_reference":null,"device_properties":{"type":"","disk_address":{"type":"","device_index":4,"adapter_type":"SCSI"},"device_type":"DISK"}},{"data_source_reference":null,"type":"","disk_size_mib":25600,"volume_group_reference":null,"device_properties":{"type":"","disk_address":{"type":"","device_index":5,"adapter_type":"SCSI"},"device_type":"DISK"}},{"data_source_reference":null,"type":"","disk_size_mib":25600,"volume_group_reference":null,"device_properties":{"type":"","disk_address":{"type":"","device_index":6,"adapter_type":"SCSI"},"device_type":"DISK"}},{"data_source_reference":null,"type":"","disk_size_mib":25600,"volume_group_reference":null,"device_properties":{"type":"","disk_address":{"type":"","device_index":7,"adapter_type":"SCSI"},"device_type":"DISK"}},{"data_source_reference":null,"type":"","disk_size_mib":25600,"volume_group_reference":null,"device_properties":{"type":"","disk_address":{"type":"","device_index":8,"adapter_type":"SCSI"},"device_type":"DISK"}}]},"availability_zone_reference":null,"backup_policy":null,"type":"","cluster_reference":null,"categories":""},"variable_list":[]}],"credential_definition_list":[{"username":"centos","description":"","type":"KEY","secret":{"attrs":{"is_secret_modified":false,"secret_reference":{}}},"name":"CENTOS","editables":{"secret":true}}],"package_definition_list":[{"description":"","action_list":[],"type":"DEB","service_local_reference_list":[{"kind":"app_service","name":"Jenkins_Master"}],"name":"JenkinsAHVMasterPkg","version":"","options":{"install_runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_package","name":"JenkinsAHVMasterPkg"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[{"kind":"app_task","name":"PackageInstallTask"}],"name":"5b445cb2_dag","state":"ACTIVE","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_package","name":"JenkinsAHVMasterPkg"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[],"name":"PackageInstallTask","state":"ACTIVE","attrs":{"script":"#!\/bin\/bash\nset -ex\n\nsudo yum install -y epel-release\nsudo yum update -y\nsudo yum install -y java-1.8.0-openjdk.x86_64 git wget\n\nwget -c https:\/\/pkg.jenkins.io\/redhat-stable\/jenkins-2.190.3-1.1.noarch.rpm\nsudo rpm -ivh jenkins-2.190.3-1.1.noarch.rpm\nsudo systemctl enable jenkins\nsudo systemctl start jenkins","type":"","command_line_args":"","exit_status":[],"script_type":"sh"},"timeout_secs":"0","type":"EXEC","variable_list":[]}],"description":"","name":"2ced9004_runbook","state":"ACTIVE","main_task_local_reference":{"kind":"app_task","name":"5b445cb2_dag"},"message_list":[],"variable_list":[]},"type":"","uninstall_runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_package","name":"JenkinsAHVMasterPkg"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[],"name":"e915b53d_dag","state":"ACTIVE","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"cef65be2_runbook","state":"ACTIVE","main_task_local_reference":{"kind":"app_task","name":"e915b53d_dag"},"message_list":[],"variable_list":[]}},"variable_list":[]},{"description":"","action_list":[],"type":"DEB","service_local_reference_list":[{"kind":"app_service","name":"Jenkins_Slave"}],"name":"JenkinsAHVSlavePkg","version":"","options":{"install_runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_package","name":"JenkinsAHVSlavePkg"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[{"kind":"app_task","name":"PackageInstallTask"}],"name":"e9524ac9_dag","state":"ACTIVE","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_package","name":"JenkinsAHVSlavePkg"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[],"name":"PackageInstallTask","state":"ACTIVE","attrs":{"script":"#!\/bin\/bash\nset -ex\n\n# Install software\nsudo yum install -y epel-release\nsudo yum update -y\nsudo yum install -y java-1.8.0-openjdk.x86_64 git docker\n\n# Configure docker\nsudo groupadd docker\nsudo gpasswd -a $USER docker\nsudo systemctl enable docker\nsudo systemctl start docker","type":"","command_line_args":"","exit_status":[],"script_type":"sh"},"timeout_secs":"0","type":"EXEC","variable_list":[]}],"description":"","name":"a6f6368b_runbook","state":"ACTIVE","main_task_local_reference":{"kind":"app_task","name":"e9524ac9_dag"},"message_list":[],"variable_list":[]},"type":"","uninstall_runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_package","name":"JenkinsAHVSlavePkg"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[],"name":"160b382b_dag","state":"ACTIVE","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"930c0460_runbook","state":"ACTIVE","main_task_local_reference":{"kind":"app_task","name":"160b382b_dag"},"message_list":[],"variable_list":[]}},"variable_list":[]},{"description":"Centos image downloaded for Jenkins ","action_list":[],"type":"SUBSTRATE_IMAGE","service_local_reference_list":[],"name":"AHV_CENTOS_76","version":"","options":{"type":"","name":"CENTOS_76","resources":{"image_type":"DISK_IMAGE","checksum":{"checksum_algorithm":"","type":"","checksum_value":""},"source_uri":"http:\/\/download.nutanix.com\/calm\/CentOS-7-x86_64-1810.qcow2","version":{"product_version":"","type":"","product_name":""},"architecture":"X86_64","type":""},"description":""},"variable_list":[]},{"description":"","action_list":[],"type":"DEB","service_local_reference_list":[{"kind":"app_service","name":"Workstation"}],"name":"Workstation_Package","version":"","options":{"install_runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_package","name":"Workstation_Package"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[{"kind":"app_task","name":"1InstallSoftware"},{"kind":"app_task","name":"2ConfKubeconfig"},{"kind":"app_task","name":"3SetupGitRepo"}],"name":"d5f773e0_dag","state":"NOT_VALIDATED","attrs":{"edges":[{"from_task_reference":{"kind":"app_task","name":"1InstallSoftware"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"2ConfKubeconfig"}},{"from_task_reference":{"kind":"app_task","name":"2ConfKubeconfig"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"3SetupGitRepo"}}],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Workstation"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[],"name":"1InstallSoftware","state":"NOT_VALIDATED","attrs":{"exit_status":[],"script":"#!\/bin\/bash\nset -ex\n\nsudo yum -y update\nsudo yum -y install vim jq git wget\n\necho \"alias k=kubectl\" | tee -a ~\/.bash_profile\necho \"export GIT_REPO_URL=https:\/\/@@{Gitea.address}@@:3000\/gitadmin\/hello-kubernetes\" | tee -a ~\/.bash_profile\necho \"export JENKINS_HOOK_URL=http:\/\/@@{Jenkins_Master.address}@@:8080\/gitea-webhook\/post\" | tee -a ~\/.bash_profile","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"CENTOS"}},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Workstation"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[],"name":"2ConfKubeconfig","state":"NOT_VALIDATED","attrs":{"exit_status":[],"script":"#!\/bin\/bash\nset -ex\n\n# Install kubectl\ncurl -LO https:\/\/storage.googleapis.com\/kubernetes-release\/release\/`curl -s https:\/\/storage.googleapis.com\/kubernetes-release\/release\/stable.txt`\/bin\/linux\/amd64\/kubectl\nchmod +x .\/kubectl\nsudo mv .\/kubectl \/usr\/local\/bin\/kubectl\n\n# Create kubeconfig\nmkdir ~\/.kube\necho '@@{Kubernetes.KUBECONFIG}@@' | base64 --decode > ~\/.kube\/config\n\n# Validate kubeconfig\nkubectl version\nkubectl get nodes\n\n# Install MetalLB\nkubectl apply -f https:\/\/raw.githubusercontent.com\/google\/metallb\/v0.8.3\/manifests\/metallb.yaml\nMLBIP1=$(netstat -rn | grep ^0.0.0.0 | awk '{print $2}' | sed -e 's\/.1$\/.46\/')\nMLBIP2=$(netstat -rn | grep ^0.0.0.0 | awk '{print $2}' | sed -e 's\/.1$\/.47\/')\ncat << EOF > metallb-config.yaml\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  namespace: metallb-system\n  name: config\ndata:\n  config: |\n    address-pools:\n    - name: default\n      protocol: layer2\n      addresses:\n      - $MLBIP1-$MLBIP2\nEOF\nkubectl apply -f metallb-config.yaml","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"CENTOS"}},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Workstation"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[],"name":"3SetupGitRepo","state":"NOT_VALIDATED","attrs":{"exit_status":[],"script":"#!\/bin\/bash\nset -ex\n\n# Set up keys\/fingerprints on workstation\necho \"@@{CENTOS.secret}@@\" > ~\/.ssh\/id_rsa\necho \"@@{CENTOS.public_key}@@\" > ~\/.ssh\/id_rsa.pub\nchmod 600 ~\/.ssh\/id_rsa*\nssh-keyscan @@{Gitea.address}@@ >> gitkey\nssh-keygen -lf gitkey\necho `cat gitkey` >> ~\/.ssh\/known_hosts\n\n# Set up password file\necho \"machine @@{Gitea.address}@@\nlogin gitadmin\npassword @@{gitea_password}@@\" > ~\/.netrc\n\n# Configure basic git settings\ngit config --global push.default simple\ngit config --global user.email \"noreply@nutanix.com\"\ngit config --global user.name \"workstation\"\ngit config --global http.sslVerify false\n\n# Clone the internal repo\ngit clone https:\/\/@@{Gitea.address}@@:3000\/gitadmin\/hello-kubernetes.git\ncd hello-kubernetes\/\n\n# Make first commit to ensure things are working properly\nsed -i 's\/world\/Nutanix\/g' server.js\ngit add server.js\ngit commit -m 'first commit, updated banner message'\ngit push -u origin master\ngit log -p -1\n","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"CENTOS"}},"timeout_secs":"0","type":"EXEC","variable_list":[]}],"description":"","name":"03b48a42_runbook","state":"NOT_VALIDATED","main_task_local_reference":{"kind":"app_task","name":"d5f773e0_dag"},"message_list":[],"variable_list":[]},"type":"","uninstall_runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_package","name":"Workstation_Package"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[],"name":"a9ac707f_dag","state":"NOT_VALIDATED","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"ba8902a7_runbook","state":"NOT_VALIDATED","main_task_local_reference":{"kind":"app_task","name":"a9ac707f_dag"},"message_list":[],"variable_list":[]}},"variable_list":[]},{"description":"","action_list":[],"type":"DEB","service_local_reference_list":[{"kind":"app_service","name":"Kubernetes"}],"name":"Kubernetes_Package","version":"","options":{"install_runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_package","name":"Kubernetes_Package"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[],"name":"bc0e031d_dag","state":"NOT_VALIDATED","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"7f750cfb_runbook","state":"NOT_VALIDATED","main_task_local_reference":{"kind":"app_task","name":"bc0e031d_dag"},"message_list":[],"variable_list":[]},"type":"","uninstall_runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_package","name":"Kubernetes_Package"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[],"name":"fd458e0c_dag","state":"NOT_VALIDATED","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"f9d0a520_runbook","state":"NOT_VALIDATED","main_task_local_reference":{"kind":"app_task","name":"fd458e0c_dag"},"message_list":[],"variable_list":[]}},"variable_list":[]},{"description":"","action_list":[],"type":"DEB","service_local_reference_list":[{"kind":"app_service","name":"Gitea"}],"name":"Gitea_Package","version":"","options":{"install_runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_package","name":"Gitea_Package"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[{"kind":"app_task","name":"1InstallSoftware"},{"kind":"app_task","name":"2DiskSetup"},{"kind":"app_task","name":"3InstallMySQL"},{"kind":"app_task","name":"4SetupMySQL"},{"kind":"app_task","name":"5CreateCerts"},{"kind":"app_task","name":"6ConfGitea"},{"kind":"app_task","name":"7GiteaService"},{"kind":"app_task","name":"8CreateRepo"},{"kind":"app_task","name":"9ConfRepo"}],"name":"0ad8eb35_dag","state":"NOT_VALIDATED","attrs":{"edges":[{"from_task_reference":{"kind":"app_task","name":"1InstallSoftware"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"2DiskSetup"}},{"from_task_reference":{"kind":"app_task","name":"2DiskSetup"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"3InstallMySQL"}},{"from_task_reference":{"kind":"app_task","name":"3InstallMySQL"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"4SetupMySQL"}},{"from_task_reference":{"kind":"app_task","name":"4SetupMySQL"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"5CreateCerts"}},{"from_task_reference":{"kind":"app_task","name":"5CreateCerts"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"6ConfGitea"}},{"from_task_reference":{"kind":"app_task","name":"6ConfGitea"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"7GiteaService"}},{"from_task_reference":{"kind":"app_task","name":"7GiteaService"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"8CreateRepo"}},{"from_task_reference":{"kind":"app_task","name":"8CreateRepo"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"9ConfRepo"}}],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Gitea"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[],"name":"1InstallSoftware","state":"NOT_VALIDATED","attrs":{"exit_status":[],"script":"#!\/bin\/bash\n\n# -*- Install Mysql\nsudo yum update -y --quiet\nsudo yum install -y  htop wget curl iotop xfs* bc unzip lvm2* git vim jq python3\nsudo pip3 install -U simplejson\n\nsudo sed -i 's\/^SELINUX=.*\/SELINUX=disabled\/' \/etc\/sysconfig\/selinux\nsudo sed -i 's\/^SELINUX=.*\/SELINUX=disabled\/' \/etc\/selinux\/config\nsudo setenforce 0\n\necho \"System packages are installed\"\n","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"CENTOS"}},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Gitea"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[],"name":"2DiskSetup","state":"NOT_VALIDATED","attrs":{"exit_status":[],"script":"#!\/bin\/bash\n\n##############\n#\n# LVM setup script for MySQL . 4 disks for DATA and 4 for logs\n# Data disks are 50GB | Log disks are 25GB \n#\n#############\n\n\n#PGSQL data\nsudo pvcreate \/dev\/sdb \/dev\/sdc \/dev\/sdd \/dev\/sde\nsudo vgcreate mysqlDataVG \/dev\/sdb \/dev\/sdd \/dev\/sdc \/dev\/sde\nsudo lvcreate -l 100%FREE -i4 -I1M -n mysqlDataLV mysqlDataVG          ## Use 1MB to avoid IO amplification \n#lvcreate -l 100%FREE -i4 -I4M -n pgDataLV pgDataVG\n\n\n#PGSQL logs\nsudo pvcreate \/dev\/sdf \/dev\/sdg \/dev\/sdh \/dev\/sdi\nsudo vgcreate mysqlLogVG \/dev\/sdf \/dev\/sdg \/dev\/sdh \/dev\/sdi\nsudo lvcreate -l 100%FREE -i2 -I1M -n mysqlLogLV mysqlLogVG            ## Use 1MB to avoid IO amplification\n#lvcreate -l 100%FREE -i2 -I4M -n pgLogLV pgLogVG\n\n\n#Disable LVM read ahead\nsudo lvchange -r 0 \/dev\/mysqlDataVG\/mysqlDataLV\nsudo lvchange -r 0 \/dev\/mysqlLogVG\/mysqlLogLV\n\n\n#Format LVMs with ext4 and use nodiscard to make sure format time is fast on Nutanix due to SCSI unmap\nsudo mkfs.ext4 -E nodiscard \/dev\/mysqlDataVG\/mysqlDataLV\nsudo mkfs.ext4 -E nodiscard \/dev\/mysqlLogVG\/mysqlLogLV\n\nsleep 30\n","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"CENTOS"}},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Gitea"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[],"name":"3InstallMySQL","state":"NOT_VALIDATED","attrs":{"exit_status":[],"script":"#!\/bin\/bash\nset -ex\n\nsudo hostnamectl set-hostname \"@@{name}@@\"\n\n# -*- Mysql installation \nsudo yum install -y --quiet \"http:\/\/repo.mysql.com\/mysql80-community-release-el7.rpm\"\nsudo yum update -y --quiet\nsudo yum install -y --quiet sshpass mysql-community-server.x86_64\n","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"CENTOS"}},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Gitea"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[],"name":"4SetupMySQL","state":"NOT_VALIDATED","attrs":{"exit_status":[],"script":"#!\/bin\/bash\n\n\necho \"!includedir \/etc\/my.cnf.d\" | sudo tee -a \/etc\/my.cnf\n\necho \"[mysqld]\nbinlog-format=mixed\nlog-bin=mysql-bin\ndatadir=\/mysql\/data\nsql_mode=NO_ENGINE_SUBSTITUTION,STRICT_TRANS_TABLES\ninnodb_data_home_dir = \/mysql\/data\ninnodb_log_group_home_dir = \/mysql\/log\ninnodb_file_per_table\ntmpdir=\/mysql\/tmpdir\ninnodb_undo_directory = \/mysql\/undo\ndefault-storage-engine = innodb\ndefault_tmp_storage_engine = innodb\ninnodb_log_files_in_group = 4\ninnodb_log_file_size = 1G\ninnodb_log_buffer_size = 8M\ninnodb_buffer_pool_size = 6G\t\nlarge-pages\t\ninnodb_buffer_pool_instances = 64\t\ninnodb_flush_method=O_DIRECT\t\ninnodb_flush_neighbors=0\t \ninnodb_flush_log_at_trx_commit=1\ninnodb_buffer_pool_dump_at_shutdown=1\t\ninnodb_buffer_pool_load_at_startup=1\t\nbulk_insert_buffer_size = 256\t\ninnodb_thread_concurrency = 16\t\n \t \n# Undo tablespace\t \ninnodb_undo_tablespaces = 5\t\n \t \n# Networking\t \nwait_timeout=57600\t \nmax_allowed_packet=1G\t\nsocket=\/var\/lib\/mysql\/mysql.sock\t \nskip-name-resolve\nport=3306\t\nmax_connections=1000\t\n\n\n[mysqld_safe]\nlog-error=\/mysql\/log\/mysqld.log\npid-file=\/var\/run\/mysqld\/mysqld.pid\" | sudo tee \/etc\/my.cnf.d\/nutanix.cnf\n\nsudo sed -i \"\/\\[mysqld\\]\/a server-id=100\" \/etc\/my.cnf.d\/nutanix.cnf\n\n\n# -*- Sysctl configuration\nmysql_grp_id=`id -g mysql`\nsudo sysctl -w vm.swappiness=0\nsudo sysctl -w vm.nr_hugepages=1024\nsudo sysctl -w vm.overcommit_memory=1\nsudo sysctl -w vm.dirty_background_ratio=5 \nsudo sysctl -w vm.dirty_ratio=15\nsudo sysctl -w vm.dirty_expire_centisecs=500\nsudo sysctl -w vm.dirty_writeback_centisecs=100\nsudo sysctl -w vm.hugetlb_shm_group=$mysql_grp_id\n\necho \"vm.swappiness=0\nvm.nr_hugepages=1024\nvm.overcommit_memory=1\nvm.dirty_background_ratio=5 \nvm.dirty_ratio=15\nvm.dirty_expire_centisecs=500\nvm.dirty_writeback_centisecs=100\nvm.hugetlb_shm_group=$mysql_grp_id\" | sudo tee  -a \/etc\/sysctl.conf\n\necho \"ACTION=='add|change', SUBSYSTEM=='block', RUN+='\/bin\/sh -c \\\"\/bin\/echo 1024 > \/sys%p\/queue\/max_sectors_kb\\\"'\" | sudo tee \/etc\/udev\/rules.d\/71-block-max-sectors.rules\n#echo 1024 | sudo tee \/sys\/block\/sd?\/queue\/max_sectors_kb\n\necho \"\/dev\/mysqlDataVG\/mysqlDataLV \/mysql\/data ext4 rw,seclabel,noatime,nobarrier,stripe=4096,data=ordered 0 0\" | sudo tee -a \/etc\/fstab\necho \"\/dev\/mysqlLogVG\/mysqlLogLV \/mysql\/log ext4 rw,seclabel,noatime,nobarrier,stripe=4096,data=ordered 0 0\" | sudo tee -a \/etc\/fstab\nsudo mkdir -p \/mysql\/log \/mysql\/data \/mysql\/tmpdir \/mysql\/undo\nsudo mount -a\nsudo chown -R mysql:mysql \/mysql\n\nsudo systemctl enable mysqld\n\nsudo rm -rf \/mysql\/data\/*\nsudo systemctl start mysqld\n\n#Fix to obtain temp password and set it to blank\npassword=$(sudo grep -oP 'temporary password(.*): \\K(\\S+)' \/var\/log\/mysqld.log)\nsudo mysqladmin --user=root --password=\"$password\" password aaBB**cc1122\nsudo mysql --user=root --password=aaBB**cc1122 -e \"UNINSTALL COMPONENT 'file:\/\/component_validate_password'\"\nsudo mysqladmin --user=root --password=\"aaBB**cc1122\" password \"\"\n\n\n#Mysql secure installation\nsudo mysql -u root<<-EOF\nALTER USER 'root'@'localhost' IDENTIFIED WITH caching_sha2_password BY '@@{gitea_password}@@';\nDELETE FROM mysql.user WHERE User='root' AND Host NOT IN ('localhost', '127.0.0.1', '::1');\nDELETE FROM mysql.user WHERE User='';\nDELETE FROM mysql.db WHERE Db='test' OR Db='test\\_%';\nCREATE DATABASE gitea;\nCREATE USER 'gitea'@'localhost' IDENTIFIED BY '@@{gitea_password}@@';\nCREATE USER 'gitea'@'127.0.0.1' IDENTIFIED BY '@@{gitea_password}@@';\nGRANT ALL PRIVILEGES ON gitea.* TO 'gitea'@'localhost';\nGRANT ALL PRIVILEGES ON gitea.* TO 'gitea'@'127.0.0.1';\nFLUSH PRIVILEGES;\nEOF\n","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"CENTOS"}},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Gitea"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[],"name":"5CreateCerts","state":"NOT_VALIDATED","attrs":{"exit_status":[],"script":"#!\/bin\/bash\nset -ex\n\n# Create Certificate Authority\nopenssl genrsa -out ca.key 4096\nopenssl req -x509 -new -nodes -sha512 -days 3650 \\\n    -subj \"\/C=US\/ST=NC\/L=Durham\/O=example\/OU=Personal\/CN=@@{address}@@\" \\\n    -key ca.key \\\n    -out ca.crt\n\n# Create Private Key and CSR\nopenssl genrsa -out @@{address}@@.key 4096\nopenssl req -sha512 -new \\\n    -subj \"\/C=US\/ST=NC\/L=Durham\/O=example\/OU=Personal\/CN=@@{address}@@\" \\\n    -key @@{address}@@.key \\\n    -out @@{address}@@.csr\n\n# Create Ext Conf file\ncat > v3.ext <<-EOF\nauthorityKeyIdentifier=keyid,issuer\nbasicConstraints=CA:FALSE\nkeyUsage = digitalSignature, nonRepudiation, keyEncipherment, dataEncipherment\nextendedKeyUsage = serverAuth \nsubjectAltName = @alt_names\n\n[alt_names]\nIP.1=@@{address}@@\nDNS.1=localhost\nEOF\n\n# Generate Certificate\nopenssl x509 -req -sha512 -days 3650 \\\n    -extfile v3.ext \\\n    -CA ca.crt -CAkey ca.key -CAcreateserial \\\n    -in @@{address}@@.csr \\\n    -out @@{address}@@.crt\n\n# Configure Server Certificate and Key\nsudo cp @@{address}@@.crt \/etc\/pki\/tls\/certs\/localhost.crt\nsudo cp @@{address}@@.key \/etc\/pki\/tls\/private\/localhost.key\n\n# Print out the ca to set as a variable\necho \"GITEA_CA=`cat ~\/ca.crt | base64 -w 0`\"","eval_variables":["GITEA_CA"],"eval_scope":"local","script_type":"sh","type":"","login_credential_local_reference":{"kind":"app_credential","name":"CENTOS"}},"timeout_secs":"0","type":"SET_VARIABLE","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Gitea"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[],"name":"6ConfGitea","state":"NOT_VALIDATED","attrs":{"exit_status":[],"script":"#!\/bin\/bash\nset -ex\n\n# Add git user\nsudo adduser --system --home \/home\/git git\nsudo mkdir \/home\/git\nsudo chown git:git \/home\/git\n\n# Create dir structure per gitea docs\nsudo mkdir -p \/var\/lib\/gitea\/{custom,data,log}\nsudo chown -R git:git \/var\/lib\/gitea\/\nsudo chmod -R 750 \/var\/lib\/gitea\/\nsudo mkdir \/etc\/gitea\nsudo chown root:git \/etc\/gitea\nsudo chmod 770 \/etc\/gitea\n\n# Get gitea binary and make executable\nwget -O gitea https:\/\/dl.gitea.io\/gitea\/1.10.2\/gitea-1.10.2-linux-amd64\nchmod +x gitea\nsudo cp gitea \/usr\/local\/bin\/gitea\n\n# Create gitea configuration file\necho '[DEFAULT]\nAPP_NAME = Gitea: Nutanix HOLs\n\n[database]\nDB_TYPE  = mysql\nHOST     = 127.0.0.1:3306\nNAME     = gitea\nUSER     = gitea\nPASSWD   = @@{gitea_password}@@\n\n[server]\nPROTOCOL  = https\nDOMAIN    = @@{address}@@\n#ROOT_URL  = https:\/\/@@{address}@@:3000\/\nHTTP_PORT = 3000\nCERT_FILE = \/etc\/pki\/tls\/certs\/localhost.crt\nKEY_FILE  = \/etc\/pki\/tls\/private\/localhost.key\n\n[security]\nINSTALL_LOCK = true\nDISABLE_GIT_HOOKS = true' | sudo tee -a \/etc\/gitea\/app.ini\nsudo chmod 666 \/etc\/gitea\/app.ini\n\n# Set up DB based on conf file\nsudo su - git -c \"gitea migrate -c \/etc\/gitea\/app.ini\"\nsudo su - git -c \"\/usr\/local\/bin\/gitea admin create-user --admin --username gitadmin  --password '@@{gitea_password}@@' --email noreply@nutanix.com -c \/etc\/gitea\/app.ini\"\n\n# Install gitea-cli\n#git clone https:\/\/github.com\/basherpm\/basher.git ~\/.basher\n#echo 'export PATH=\"$HOME\/.basher\/bin:$PATH\"' >> ~\/.bash_profile\n#echo 'eval \"$(basher init -)\"' >> ~\/.bash_profile\n#source ~\/.bash_profile\n#basher install bashup\/gitea-cli\n#echo 'GITEA_USER=gitadmin\n#GITEA_API_TOKEN=\n#GITEA_URL=https:\/\/@@{address}@@:3000\/\n#curl() { command curl --insecure \"$@\"; }' | sudo tee \/etc\/gitea-cli\/gitearc","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"CENTOS"}},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Gitea"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[],"name":"7GiteaService","state":"NOT_VALIDATED","attrs":{"exit_status":[],"script":"#!\/bin\/bash\nset -ex\n\n# Create the unit file\necho '[Unit]\nDescription=Gitea (Git with a cup of tea)\nAfter=network.target\nAfter=mysql.service\n\n[Service]\nRestartSec=2s\nType=simple\nUser=git\nGroup=git\nWorkingDirectory=\/var\/lib\/gitea\/\nExecStart=\/usr\/local\/bin\/gitea web -c \/etc\/gitea\/app.ini\nRestart=always\nEnvironment=USER=git HOME=\/home\/git GITEA_WORK_DIR=\/var\/lib\/gitea\n\n[Install]\nWantedBy=multi-user.target' | sudo tee \/etc\/systemd\/system\/gitea.service\n\n# Reload daemons and start service\nsudo systemctl daemon-reload\nsudo systemctl start gitea\nsudo systemctl enable gitea\nsudo systemctl status gitea -l","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"CENTOS"}},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Gitea"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[],"name":"8CreateRepo","state":"NOT_VALIDATED","attrs":{"script":"url     = \"https:\/\/@@{address}@@:3000\/api\/v1\/user\/repos\"\nheaders = {'Content-Type': 'application\/json', 'Accept': 'application\/json'}\n\npayload = {\n  \"auto_init\": False,\n  \"description\": \"Hello Kubernetes - Nutanix HOLs\",\n  \"name\": \"hello-kubernetes\",\n  \"private\": False\n}\n\ngitea_user = 'gitadmin'\ngitea_pass = '@@{gitea_password}@@'\n\nresp = urlreq(url, verb='POST', auth='BASIC', user=gitea_user, passwd=gitea_pass, params=json.dumps(payload), headers=headers)\n\nif resp.ok:\n  print json.dumps(json.loads(resp.content), indent=4)\nelse:\n  print \"Post Repo Create request failed\", json.dumps(json.loads(resp.content), indent=4)\n  exit(1)","type":"","command_line_args":"","exit_status":[],"script_type":"static"},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Gitea"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[],"name":"9ConfRepo","state":"NOT_VALIDATED","attrs":{"exit_status":[],"script":"#!\/bin\/bash\nset -ex\n\n# Set up password file\necho \"machine @@{address}@@\nlogin gitadmin\npassword @@{gitea_password}@@\" > ~\/.netrc\n\n# Configure basic git settings\ngit config --global push.default simple\ngit config --global user.email \"noreply@nutanix.com\"\ngit config --global user.name \"gitadmin\"\ngit config --global http.sslVerify false\n\n# Setup repo\ngit clone https:\/\/github.com\/MichaelHaigh\/hello-kubernetes.git\ncd hello-kubernetes\/\ngit remote set-url origin https:\/\/@@{address}@@:3000\/gitadmin\/hello-kubernetes.git\ngit push -u origin master\n\n# Add webhook\n#sudo su - git -c \"wget -O \/home\/git\/gitea-repositories\/gitadmin\/hello-kubernetes.git\/hooks\/post-receive https:\/\/raw.githubusercontent.com\/metajack\/notify-webhook\/master\/notify-webhook.py\"","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"CENTOS"}},"timeout_secs":"0","type":"EXEC","variable_list":[]}],"description":"","name":"a001568d_runbook","state":"NOT_VALIDATED","main_task_local_reference":{"kind":"app_task","name":"0ad8eb35_dag"},"message_list":[],"variable_list":[]},"type":"","uninstall_runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_package","name":"Gitea_Package"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[],"name":"3eb1dcf2_dag","state":"NOT_VALIDATED","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"542b10b9_runbook","state":"NOT_VALIDATED","main_task_local_reference":{"kind":"app_task","name":"3eb1dcf2_dag"},"message_list":[],"variable_list":[]}},"variable_list":[]}],"app_profile_list":[{"deployment_create_list":[{"type":"GREENFIELD","action_list":[],"name":"487f0f9a_deployment","min_replicas":"1","default_replicas":"1","depends_on_list":[],"published_service_local_reference_list":[],"max_replicas":"1","package_local_reference_list":[{"kind":"app_package","name":"JenkinsAHVMasterPkg"}],"substrate_local_reference":{"kind":"app_substrate","name":"JenkinsAHVMaster"},"variable_list":[],"description":""},{"type":"GREENFIELD","action_list":[],"name":"ffdda4d4_deployment","min_replicas":"1","default_replicas":"1","depends_on_list":[],"published_service_local_reference_list":[],"max_replicas":"3","package_local_reference_list":[{"kind":"app_package","name":"JenkinsAHVSlavePkg"}],"substrate_local_reference":{"kind":"app_substrate","name":"JenkinsAHVSlave"},"variable_list":[],"description":""},{"type":"GREENFIELD","action_list":[],"name":"95c1ab56_deployment","min_replicas":"1","default_replicas":"1","depends_on_list":[],"published_service_local_reference_list":[],"max_replicas":"1","package_local_reference_list":[{"kind":"app_package","name":"Workstation_Package"}],"substrate_local_reference":{"kind":"app_substrate","name":"Workstation_AHV"},"variable_list":[],"description":""},{"type":"GREENFIELD","action_list":[],"name":"0d703be9_deployment","min_replicas":"1","default_replicas":"1","depends_on_list":[],"published_service_local_reference_list":[],"max_replicas":"1","package_local_reference_list":[{"kind":"app_package","name":"Kubernetes_Package"}],"substrate_local_reference":{"kind":"app_substrate","name":"Karbon_Kubernetes"},"variable_list":[],"description":""},{"type":"GREENFIELD","action_list":[],"name":"b7e85a06_deployment","min_replicas":"1","default_replicas":"1","depends_on_list":[],"published_service_local_reference_list":[],"max_replicas":"1","package_local_reference_list":[{"kind":"app_package","name":"Gitea_Package"}],"substrate_local_reference":{"kind":"app_substrate","name":"Gitea_AHV"},"variable_list":[],"description":""}],"description":"","action_list":[{"description":"","type":"user","critical":false,"runbook":{"task_definition_list":[{"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"1GetCookie"},{"kind":"app_task","name":"2GetKubeconfig"},{"kind":"app_task","name":"3SetKubeConfig"}],"name":"f8973029_dag","attrs":{"edges":[{"from_task_reference":{"kind":"app_task","name":"1GetCookie"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"2GetKubeconfig"}},{"from_task_reference":{"kind":"app_task","name":"2GetKubeconfig"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"3SetKubeConfig"}}],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Kubernetes"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"1GetCookie","attrs":{"exit_status":[],"script":"# Set the jwt, headers and payload\njwt = '@@{calm_jwt}@@'\nheaders = {'Content-Type': 'application\/json', 'Accept': 'application\/json',\n           'Authorization': 'Bearer {}'.format(jwt)}\npayload = {}\n\n# Set the address and make images call to get our cookie\nurl = \"https:\/\/localhost:9440\/api\/nutanix\/v3\/images\/list\"\nresp = urlreq(url, verb='POST', params=json.dumps(payload), headers=headers, verify=False)\n\n# If the images call went through successfully, extract the cookie and make acs\/list\nif resp.ok:\n\n  # Set the new headers and cookies, and print cookies for next task\n  headers = {'Content-Type': 'application\/json', 'Accept': 'application\/json'}\n  cookies = {'NTNX_IGW_SESSION': resp.cookies['NTNX_IGW_SESSION']}\n  print \"NEW_COOKIES={0}\".format(resp.cookies['NTNX_IGW_SESSION'])\n  exit(0)\n\n# If the call failed\nelse:\n  print \"Images call failed\", json.dumps(json.loads(resp.content), indent=4)\n  exit(1)","eval_variables":["NEW_COOKIES"],"eval_scope":"local","type":"","script_type":"static"},"timeout_secs":"0","type":"SET_VARIABLE","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Kubernetes"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"2GetKubeconfig","attrs":{"exit_status":[],"script":"# Set the headers, payload, and cookies\nheaders = {'Content-Type': 'application\/json', 'Accept': 'application\/json'}\ncookies = {'NTNX_IGW_SESSION': '@@{NEW_COOKIES}@@'}\n\n# Set the address and make kubeconfig call\nurl = \"https:\/\/localhost:7050\/acs\/k8s\/cluster\/@@{K8S_UUID}@@\/kubeconfig\"\nresp = urlreq(url, verb='GET', cookies=cookies, headers=headers, verify=False)\n\n# If the call went through successfully, print out the kubeconfig\nif resp.ok:\n  print \"NEW_KUBECONFIG={0}\".format(json.loads(resp.content)['yml_config'])\n  exit(0)\n\n# If the call failed\nelse:\n  print \"Get kubeconfig failed\", json.dumps(json.loads(resp.content), indent=4)\n  exit(1)","eval_variables":["NEW_KUBECONFIG"],"eval_scope":"local","type":"","script_type":"static"},"timeout_secs":"0","type":"SET_VARIABLE","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Workstation"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"3SetKubeConfig","attrs":{"exit_status":[],"script":"#!\/bin\/bash\nset -ex\n\n# Create kubeconfig\necho '@@{Kubernetes.NEW_KUBECONFIG}@@' | base64 --decode > ~\/.kube\/config\n\n# Validate kubeconfig\nkubectl version\nkubectl get nodes","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"CENTOS"}},"timeout_secs":"0","type":"EXEC","variable_list":[]}],"description":"","name":"eff3ef54_runbook","main_task_local_reference":{"kind":"app_task","name":"f8973029_dag"},"variable_list":[]},"name":"RefreshKubeConfig"}],"name":"Nutanix","variable_list":[{"val_type":"STRING","is_mandatory":true,"description":"Enter the (case sensitive) name of a Karbon Kubernetes cluster you wish to use for this lab.","data_type":"BASE","type":"LOCAL","name":"karbon_cluster_name","value":"","label":"","attrs":{"type":""},"editables":{"value":true},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}},{"val_type":"STRING","is_mandatory":true,"description":"","data_type":"BASE","type":"SECRET","name":"gitea_password","value":"","label":"","attrs":{"is_secret_modified":false,"secret_reference":{},"type":"SECRET"},"editables":{"value":true},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}}]}],"published_service_definition_list":[],"default_credential_local_reference":{"kind":"app_credential","name":"CENTOS"},"type":"USER"},"name":"CICD_Infra"},"api_version":"3.0","metadata":{"last_update_time":"1580328184919537","kind":"blueprint","spec_version":103,"creation_time":"1578967647440505","categories":{"AppFamily":"DevOps"},"name":"CICD_Infra"}}