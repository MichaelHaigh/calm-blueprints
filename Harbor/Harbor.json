{"status":{},"product_version":"2.7.1.2","spec":{"description":"* [Harbor Application Link](https:\/\/@@{Harbor.address}@@\/)","resources":{"client_attrs":{"b6af37be_deployment":{"y":457.5,"x":781}},"service_definition_list":[{"singleton":false,"action_list":[{"description":"System action for creating an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Harbor"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"7443d621_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"f7db10f2_runbook","main_task_local_reference":{"kind":"app_task","name":"7443d621_dag"},"variable_list":[]},"name":"action_create"},{"description":"System action for deleting an application. Deletes created VMs as well","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Harbor"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"e9030eb7_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"43219df5_runbook","main_task_local_reference":{"kind":"app_task","name":"e9030eb7_dag"},"variable_list":[]},"name":"action_delete"},{"description":"System action for starting an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Harbor"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"15f723ee_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"7e915063_runbook","main_task_local_reference":{"kind":"app_task","name":"15f723ee_dag"},"variable_list":[]},"name":"action_start"},{"description":"System action for stopping an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Harbor"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"03f9df8a_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"54ea4c9e_runbook","main_task_local_reference":{"kind":"app_task","name":"03f9df8a_dag"},"variable_list":[]},"name":"action_stop"},{"description":"System action for restarting an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Harbor"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"1760a042_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"067cd625_runbook","main_task_local_reference":{"kind":"app_task","name":"1760a042_dag"},"variable_list":[]},"name":"action_restart"}],"depends_on_list":[],"name":"Harbor","port_list":[],"tier":"","variable_list":[],"description":""}],"substrate_definition_list":[{"description":"","action_list":[],"type":"AHV_VM","name":"Harbor_AHV","readiness_probe":{"connection_type":"SSH","retries":"5","disable_readiness_probe":false,"address":"@@{platform.status.resources.nic_list[0].ip_endpoint_list[0].ip}@@","delay_secs":"60","connection_port":22,"login_credential_local_reference":{"kind":"app_credential","name":"CENTOS"}},"editables":{"create_spec":{"resources":{"nic_list":{},"serial_port_list":{}}}},"os_type":"Linux","create_spec":{"name":"vm-@@{calm_array_index}@@-@@{calm_time}@@","resources":{"nic_list":[{"nic_type":"NORMAL_NIC","ip_endpoint_list":[],"network_function_chain_reference":null,"network_function_nic_type":"INGRESS","mac_address":"","subnet_reference":{"kind":"subnet","type":"","name":"","uuid":"0e26c135-d478-428e-9fb8-22c0acfa5f3a"},"type":""}],"serial_port_list":[],"guest_tools":null,"num_vcpus_per_socket":1,"num_sockets":4,"gpu_list":[],"memory_size_mib":8192,"parent_reference":null,"hardware_clock_timezone":"","guest_customization":{"cloud_init":{"meta_data":"","type":"","user_data":"#cloud-config\nusers:\n  - name: centos\n    ssh-authorized-keys:\n      - @@{CENTOS.public_key}@@\n    sudo: ['ALL=(ALL) NOPASSWD:ALL']\nruncmd:\n - parted \/dev\/sdb mklabel gpt\n - parted --align optimal \/dev\/sdb mkpart primary 0% 100%\n - mkfs -t xfs \/dev\/sdb1\n - mkdir \/data\nmounts:\n - [\/dev\/sdb1, \/data, \"xfs\",\"defaults\", \"0\", \"2\"]"},"type":"","sysprep":null},"power_state":"ON","type":"","boot_config":{"boot_device":{"type":"","disk_address":{"type":"","device_index":0,"adapter_type":"SCSI"}},"type":"","boot_type":"","mac_address":""},"disk_list":[{"data_source_reference":{"kind":"app_package","type":"","name":"CentOS_7_Image","uuid":"96354982-a820-e78a-fe5c-36c5dd20f6d3"},"type":"","disk_size_mib":0,"volume_group_reference":null,"device_properties":{"type":"","disk_address":{"type":"","device_index":0,"adapter_type":"SCSI"},"device_type":"DISK"}},{"data_source_reference":null,"type":"","disk_size_mib":1048576,"volume_group_reference":null,"device_properties":{"type":"","disk_address":{"type":"","device_index":1,"adapter_type":"SCSI"},"device_type":"DISK"}}]},"availability_zone_reference":null,"backup_policy":null,"type":"","cluster_reference":null,"categories":""},"variable_list":[]}],"credential_definition_list":[{"username":"centos","description":"","type":"KEY","secret":{"attrs":{"is_secret_modified":false,"secret_reference":{}}},"name":"CENTOS"}],"package_definition_list":[{"description":"","action_list":[],"type":"DEB","service_local_reference_list":[{"kind":"app_service","name":"Harbor"}],"name":"Package1","version":"","options":{"install_runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_package","name":"Package1"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[{"kind":"app_task","name":"1InstallSoftware"},{"kind":"app_task","name":"2GenerateCerts"},{"kind":"app_task","name":"3ConfigureDocker"},{"kind":"app_task","name":"4InstallHarbor"}],"name":"559b4f32_dag","state":"ACTIVE","attrs":{"edges":[{"from_task_reference":{"kind":"app_task","name":"1InstallSoftware"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"2GenerateCerts"}},{"from_task_reference":{"kind":"app_task","name":"2GenerateCerts"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"3ConfigureDocker"}},{"from_task_reference":{"kind":"app_task","name":"3ConfigureDocker"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"4InstallHarbor"}}],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Harbor"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[],"name":"1InstallSoftware","state":"ACTIVE","attrs":{"exit_status":[],"script":"#!\/bin\/bash\nset -ex\n\n# Set hostname to IP\n#sudo hostnamectl set-hostname @@{address}@@\n\n# Run mount to ensure \/dev\/sdb1 is mounted\nsudo mount -a\nsudo yum -y update\nsudo yum install -y yum-utils device-mapper-persistent-data lvm2 wget\nsudo yum-config-manager --add-rep https:\/\/download.docker.com\/linux\/centos\/docker-ce.repo\nsudo yum install -y docker-ce docker-ce-cli containerd.io","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"CENTOS"}},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Harbor"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[],"name":"2GenerateCerts","state":"ACTIVE","attrs":{"exit_status":[],"script":"#!\/bin\/bash\nset -ex\n\n# Create Certificate Authority\nopenssl genrsa -out ca.key 4096\nopenssl req -x509 -new -nodes -sha512 -days 3650 \\\n    -subj \"\/C=US\/ST=NC\/L=Durham\/O=example\/OU=Personal\/CN=@@{address}@@\" \\\n    -key ca.key \\\n    -out ca.crt\n\n# Create Private Key and CSR\nopenssl genrsa -out @@{address}@@.key 4096\nopenssl req -sha512 -new \\\n    -subj \"\/C=US\/ST=NC\/L=Durham\/O=example\/OU=Personal\/CN=@@{address}@@\" \\\n    -key @@{address}@@.key \\\n    -out @@{address}@@.csr\n\n# Create Ext Conf file\ncat > v3.ext <<-EOF\nauthorityKeyIdentifier=keyid,issuer\nbasicConstraints=CA:FALSE\nkeyUsage = digitalSignature, nonRepudiation, keyEncipherment, dataEncipherment\nextendedKeyUsage = serverAuth \nsubjectAltName = @alt_names\n\n[alt_names]\nIP.1=@@{address}@@\nDNS.1=localhost\nEOF\n\n# Generate Certificate\nopenssl x509 -req -sha512 -days 3650 \\\n    -extfile v3.ext \\\n    -CA ca.crt -CAkey ca.key -CAcreateserial \\\n    -in @@{address}@@.csr \\\n    -out @@{address}@@.crt\n\n# Configure Server Certificate and Key for Harbor\nsudo mkdir \/data\/cert\nsudo cp @@{address}@@.crt \/data\/cert\/\nsudo cp @@{address}@@.key \/data\/cert\/\n\n# Configure Server Certificate, Key and CA for Docker\nopenssl x509 -inform PEM -in @@{address}@@.crt -out @@{address}@@.cert\nsudo mkdir -p \/etc\/docker\/certs.d\/@@{address}@@\nsudo cp @@{address}@@.cert \/etc\/docker\/certs.d\/@@{address}@@\/\nsudo cp @@{address}@@.key \/etc\/docker\/certs.d\/@@{address}@@\/\nsudo cp ca.crt \/etc\/docker\/certs.d\/@@{address}@@\/\n#sudo mkdir -p \/etc\/docker\/certs.d\/localhost\n#sudo cp @@{address}@@.cert \/etc\/docker\/certs.d\/localhost\/\n#sudo cp @@{address}@@.key \/etc\/docker\/certs.d\/localhost\/\n#sudo cp ca.crt \/etc\/docker\/certs.d\/localhost\/\n#sudo cp @@{address}@@.crt \/etc\/pki\/ca-trust\/source\/anchors\/.\n#sudo update-ca-trust","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"CENTOS"}},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Harbor"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[],"name":"3ConfigureDocker","state":"ACTIVE","attrs":{"exit_status":[],"script":"#!\/bin\/bash\nset -ex\n\n# Point docker at our 1TiB \/dockerdata directory\nsudo sed -i 's|ExecStart=\/usr\/bin\/dockerd|ExecStart=\/usr\/bin\/dockerd -g \/dockerdata|g' \/lib\/systemd\/system\/docker.service\n\n# Enable and start docker up\nsudo systemctl enable docker\nsudo systemctl start docker\n\n# Install docker-compose\nsudo curl -L \"https:\/\/github.com\/docker\/compose\/releases\/download\/@@{docker_compose_version}@@\/docker-compose-$(uname -s)-$(uname -m)\" -o \/usr\/local\/bin\/docker-compose\nsudo chmod +x \/usr\/local\/bin\/docker-compose\nsudo ln -s \/usr\/local\/bin\/docker-compose \/usr\/bin\/docker-compose","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"CENTOS"}},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Harbor"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[],"name":"4InstallHarbor","state":"ACTIVE","attrs":{"exit_status":[],"script":"#!\/bin\/bash\nset -ex\n\n# Download the online harbor installer\n#wget https:\/\/storage.googleapis.com\/harbor-releases\/release-@@{harbor_version}@@\/harbor-online-installer-v@@{harbor_version}@@.tgz\nwget https:\/\/storage.googleapis.com\/harbor-releases\/release-@@{harbor_version}@@\/harbor-offline-installer-v@@{harbor_version}@@.tgz\ntar xvf harbor-offline-installer-v@@{harbor_version}@@.tgz\n\n# Handle special characters in the passwords\ndb_password='@@{postgres_db_password}@@'\ndb_escaped_pass=\"${db_password\/\/\\\/\/\\\\\/}\"\nh_password='@@{harbor_admin_password}@@'\nh_escaped_pass=\"${h_password\/\/\\\/\/\\\\\/}\"\n\n# Modify the harbor.yml file\ncd ~\/harbor\nsed -i \"s\/reg.mydomain.com\/@@{address}@@\/g\" harbor.yml\nsed -i \"s\/root123\/`echo $db_escaped_pass`\/g\" harbor.yml\nsed -i \"s\/Harbor12345\/`echo $h_escaped_pass`\/g\" harbor.yml\nsed -i \"s\/# https:\/https:\/g\" harbor.yml\nsed -i \"s\/#   port: 443\/  port: 443\/g\" harbor.yml\nsed -i \"s|#   certificate: \/your\/certificate\/path|  certificate: \/data\/cert\/@@{address}@@.crt|g\" harbor.yml\nsed -i \"s|#   private_key: \/your\/private\/key\/path|  private_key: \/data\/cert\/@@{address}@@.key|g\" harbor.yml\nsed -i '\/    - core\/d' harbor.yml\nsed -i '\/    - jobservice\/d' harbor.yml\nsed -i '\/    - clair\/d' harbor.yml\n\n# Generate string to install optional components\nflags=\"\"\nif [ \"@@{install_clair}@@\" == \"true\" ]\nthen\n  flags=$flags\"--with-clair \"\nfi\nif [ \"@@{install_chartmuseum}@@\" == \"true\" ]\nthen\n  flags=$flags\"--with-chartmuseum \"\nfi\nif [ \"@@{install_notary}@@\" == \"true\" ]\nthen\n  flags=$flags\"--with-notary \"\nfi\n\n# Install Harbor\nsudo .\/install.sh $flags","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"CENTOS"}},"timeout_secs":"0","type":"EXEC","variable_list":[]}],"description":"","name":"34443a76_runbook","state":"ACTIVE","main_task_local_reference":{"kind":"app_task","name":"559b4f32_dag"},"message_list":[],"variable_list":[]},"type":"","uninstall_runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_package","name":"Package1"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[],"name":"a6747103_dag","state":"ACTIVE","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"205db822_runbook","state":"ACTIVE","main_task_local_reference":{"kind":"app_task","name":"a6747103_dag"},"message_list":[],"variable_list":[]}},"variable_list":[]},{"description":"","action_list":[],"type":"SUBSTRATE_IMAGE","service_local_reference_list":[],"name":"CentOS_7_Image","version":"","options":{"type":"","name":"CentOS_7","resources":{"image_type":"DISK_IMAGE","checksum":{},"source_uri":"http:\/\/download.nutanix.com\/calm\/CentOS-7-x86_64-1810.qcow2","version":{"product_version":"7","type":"","product_name":"CentOS"},"architecture":"X86_64","type":""},"description":""},"variable_list":[]}],"app_profile_list":[{"deployment_create_list":[{"type":"GREENFIELD","action_list":[],"depends_on_list":[],"name":"b6af37be_deployment","published_service_local_reference_list":[],"max_replicas":"1","package_local_reference_list":[{"kind":"app_package","name":"Package1"}],"substrate_local_reference":{"kind":"app_substrate","name":"Harbor_AHV"},"min_replicas":"1","variable_list":[],"description":""}],"description":"","action_list":[],"name":"Default","variable_list":[{"val_type":"STRING","is_mandatory":true,"description":"Select a valid release from the following page:\nhttps:\/\/github.com\/docker\/compose\/releases\nChanging from 1.24.1 may cause this blueprint to not work.","data_type":"BASE","type":"LOCAL","name":"docker_compose_version","value":"1.24.1","label":"","attrs":{"type":""},"editables":{"value":true},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}},{"regex":{"should_validate":false,"value":"^(\\d+\\.)?(\\d+\\.)?"},"val_type":"STRING","is_mandatory":true,"description":"Select a valid release from the following page (be sure to omit the 'v'):\nhttps:\/\/github.com\/goharbor\/harbor\/releases\nChanging from v1.9.0 may cause this blueprint to not work.","data_type":"BASE","type":"LOCAL","name":"harbor_version","value":"1.9.0","label":"","attrs":{"type":""},"editables":{"value":true},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}},{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"SECRET","name":"postgres_db_password","value":"","label":"","attrs":{"is_secret_modified":false,"secret_reference":{},"type":"SECRET"},"editables":{"value":true},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}},{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"SECRET","name":"harbor_admin_password","value":"","label":"","attrs":{"is_secret_modified":false,"secret_reference":{},"type":"SECRET"},"editables":{"value":true},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}},{"regex":{"should_validate":false,"value":"^.*$"},"val_type":"STRING","is_mandatory":true,"description":"Choose whether or not to install Notary (content trust).","data_type":"BASE","type":"LOCAL","name":"install_notary","value":"true","label":"","attrs":{"type":"LOCAL"},"editables":{"value":true},"is_hidden":false,"options":{"type":"PREDEFINED","choices":["true","false"]}},{"val_type":"STRING","is_mandatory":true,"description":"Choose whether or not to install Clair (vulnerability scanning).","data_type":"BASE","type":"LOCAL","name":"install_clair","value":"true","label":"","attrs":{"type":""},"editables":{"value":true},"is_hidden":false,"options":{"type":"PREDEFINED","choices":["true","false"]}},{"val_type":"STRING","is_mandatory":true,"description":"Choose whether or not to install ChartMuseum (Helm chart repository).","data_type":"BASE","type":"LOCAL","name":"install_chartmuseum","value":"true","label":"","attrs":{"type":"LOCAL"},"editables":{"value":true},"is_hidden":false,"options":{"type":"PREDEFINED","choices":["true","false"]}}]}],"published_service_definition_list":[],"default_credential_local_reference":{"kind":"app_credential","name":"CENTOS"},"type":"USER"},"name":"Harbor"},"api_version":"3.0","metadata":{"last_update_time":"1571165770957212","kind":"blueprint","spec_version":56,"creation_time":"1571073682034192","name":"Harbor"}}